#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>
#include <LiquidCrystal_I2C.h>

LiquidCrystal_I2C lcd(0x27, 16, 2);

#define BLYNK_PRINT Serial
#define RELAY 5
#define SENSOR1  25
#define SENSOR2  26
#define LED 12

char auth[] = "ur auth code";
char ssid[] = "ECE";
char pass[] = "123456789";

long currentMillis1 = 0, previousMillis1 = 0;
int interval1 = 1000;
float calibrationFactor1 = 6;
volatile byte pulseCount1;
byte pulse1Sec1 = 0;
float flowRate1;
unsigned int flowMilliLitres1;
unsigned long totalMilliLitres1;

long currentMillis2 = 0, previousMillis2 = 0;
int interval2 = 1000;
float calibrationFactor2 = 6;
volatile byte pulseCount2;
byte pulse1Sec2 = 0;
float flowRate2;
unsigned int flowMilliLitres2;
unsigned long totalMilliLitres2;

void IRAM_ATTR pulseCounter1() {
    pulseCount1++;
}

void IRAM_ATTR pulseCounter2() {
    pulseCount2++;
}

void setup() {
    Serial.begin(115200);
    pinMode(SENSOR1, INPUT_PULLUP);
    pinMode(SENSOR2, INPUT_PULLUP);
    pinMode(RELAY, OUTPUT);
    pinMode(LED, OUTPUT);
    digitalWrite(RELAY, LOW);
    digitalWrite(LED, LOW);
    
    pulseCount1 = 0;
    flowRate1 = 0.0;
    flowMilliLitres1 = 0;
    totalMilliLitres1 = 0;
    previousMillis1 = 0;
    
    pulseCount2 = 0;
    flowRate2 = 0.0;
    flowMilliLitres2 = 0;
    totalMilliLitres2 = 0;
    previousMillis2 = 0;
    
    attachInterrupt(digitalPinToInterrupt(SENSOR1), pulseCounter1, FALLING);
    attachInterrupt(digitalPinToInterrupt(SENSOR2), pulseCounter2, FALLING);
    
    Blynk.begin(auth, ssid, pass);
    lcd.init();
    lcd.backlight();
    lcd.setCursor(1, 0);
    lcd.print("IoT Based Water");
    lcd.setCursor(1, 1);
    lcd.print("Leakage monitor");
    delay(2000);
}

void loop() {
    Blynk.run();
    
    currentMillis1 = millis();
    if (currentMillis1 - previousMillis1 > interval1) {
        pulse1Sec1 = pulseCount1;
        pulseCount1 = 0;
        long timeDiff = currentMillis1 - previousMillis1;
        previousMillis1 = currentMillis1;
        
        if (timeDiff > 0) {
            flowRate1 = ((1000.0 / timeDiff) * pulse1Sec1) / calibrationFactor1;
        } else {
            flowRate1 = 0;
        }
        
        flowMilliLitres1 = (flowRate1 / 60) * 1000;
        totalMilliLitres1 += flowMilliLitres1;
        
        Serial.print("Flow rate1: ");
        Serial.print(int(flowRate1));
        Serial.print("mL/S\t");
        Serial.print("Volunm1: ");
        Serial.print(totalMilliLitres1);
        Serial.print("mL / ");
        Serial.print(totalMilliLitres1 / 1000);
        Serial.println("L");
        
        lcd.setCursor(1, 0);
        lcd.print("Flow1=");
        lcd.print(int(flowRate1));
        lcd.print(" mL/S   ");
        Blynk.virtualWrite(V0, int(flowRate1));
    }
    
    currentMillis2 = millis();
    if (currentMillis2 - previousMillis2 > interval2) {
        pulse1Sec2 = pulseCount2;
        pulseCount2 = 0;
        long timeDiff = currentMillis2 - previousMillis2;
        previousMillis2 = currentMillis2;
        
        if (timeDiff > 0) {
            flowRate2 = ((1000.0 / timeDiff) * pulse1Sec2) / calibrationFactor2;
        } else {
            flowRate2 = 0;
        }
        
        flowMilliLitres2 = (flowRate2 / 60) * 1000;
        totalMilliLitres2 += flowMilliLitres2;
        
        Serial.print("Flow rate2: ");
        Serial.print(int(flowRate2));
        Serial.print("mL/S\t");
        Serial.print("Volunm2: ");
        Serial.print(totalMilliLitres2);
        Serial.print("mL / ");
        Serial.print(totalMilliLitres2 / 1000);
        Serial.println("L");
        
        lcd.setCursor(1, 1);
        lcd.print("Flow2=");
        lcd.print(int(flowRate2));
        lcd.print(" mL/S   ");
        Blynk.virtualWrite(V1, int(flowRate2));
    }
    
    if (flowRate2 < flowRate1 && flowRate2 < 8) {
        lcd.setCursor(1, 0);
        lcd.print("Leakage occurred ");
        lcd.setCursor(1, 1);
        lcd.print("Flow 1 to 2  ");
        digitalWrite(RELAY, HIGH);
        digitalWrite(LED, HIGH);
        Blynk.logEvent("flow_notify", "Water Leakage Detected");
    } else {
        digitalWrite(RELAY, LOW);
        digitalWrite(LED, LOW);
    }
}
